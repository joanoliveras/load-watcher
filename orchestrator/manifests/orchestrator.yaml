apiVersion: v1
kind: Namespace
metadata:
  name: orchestrator
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: orchestrator
  namespace: orchestrator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: orchestrator
  template:
    metadata:
      labels:
        app: orchestrator
    spec:
      containers:
        - name: orchestrator
          image: registry.gitlab.bsc.es/datacentric-computing/cloudskin-project/cloudskin-registry/orchestrator:latest
          imagePullPolicy: Always
          env:
            - name: ORCH_LOAD_WATCHER_URL
              value: http://load-watcher.loadwatcher.svc.cluster.local:2020/watcher
            - name: ORCH_ML_AGENT_URL
              value: http://ml-agent.ml-agent.svc.cluster.local:8080/predict
            - name: ORCH_POLL_INTERVAL_SECONDS
              value: "60"
            - name: ORCH_REQUEST_TIMEOUT_SECONDS
              value: "15"
            - name: ORCH_LOG_LEVEL
              value: INFO
          ports:
            - name: metrics
              containerPort: 9105
---
apiVersion: v1
kind: Service
metadata:
  name: orchestrator-metrics
  namespace: orchestrator
  labels:
    app: orchestrator
spec:
  selector:
    app: orchestrator
  ports:
    - name: metrics
      port: 9105
      targetPort: metrics
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: orchestrator
  namespace: monitoring        
spec:
  namespaceSelector:
    matchNames:
    - orchestrator            
  selector:
    matchLabels:
      app: orchestrator       
  endpoints:
  - port: metrics
    interval: 30s